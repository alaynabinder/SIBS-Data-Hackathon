---
title: "Analysis"
author: "Alayna Binder, Isabella Shubert, Preeti Nagalamadaka and Olivia Xiao"
output: html_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyverse)
library(tidymodels)
library(parsnip)
library(patchwork)
library(plotly)
library(widgetframe)
library(naniar)
library(mice)
library(car)
library(MASS) # backward selection
data <- read.csv('MICD.csv')
```

```{r imputing_data, echo=FALSE, warning=FALSE}

superdata <- data

# superdata <- superdata %>%
#   mutate(AGE_GROUP = case_when(AGE >= 25 & AGE <= 34 ~ '25-34', AGE >= 35 & AGE <= 44 ~ '35-44', AGE >= 45 & AGE <= 54 ~ '45-54', AGE >= 55  & AGE <= 64 ~ '55-64', AGE >= 65 & AGE <= 74 ~ '65-74', AGE >= 75 & AGE <= 84 ~ '75-84', AGE >= 85 ~ '85+')) %>%
#   mutate(SEX = case_when(SEX == 0 ~ 'Female', SEX == 1 ~ 'Male')) %>%
#   relocate(AGE_GROUP, .after = AGE) %>%
#   dplyr::select(- c(IBS_NASL, KFK_BLOOD, S_AD_KBRIG, D_AD_KBRIG, NOT_NA_KB, LID_KB, NA_KB, FIBR_PREDS, PREDS_TAH, JELUD_TAH, FIBR_JELUD, A_V_BLOK, OTEK_LANC, RAZRIV, DRESSLER, ZSN, P_IM_STEN, LET_IS))
# 
# # Factoring ordinal variables
# superdata$FK_STENOK = as.factor(superdata$FK_STENOK)
# superdata$IBS_POST = as.factor(superdata$IBS_POST)
# superdata$GB = as.factor(superdata$GB)
# superdata$DLIT_AG = as.factor(superdata$DLIT_AG)
# superdata$ZSN_A = as.factor(superdata$ZSN_A)
# superdata$TIME_B_S = as.factor(superdata$TIME_B_S)
# 
# # Superdata for admission
# superdata_admission <- superdata %>%
#   dplyr::select(- c(R_AB_1_n, NA_R_1_n, NOT_NA_1_n, R_AB_2_n, NA_R_2_n, NOT_NA_2_n, R_AB_3_n, NA_R_3_n, NOT_NA_3_n))
# 
# # Superdata for stay
# superdata_stay <- superdata %>%
#   dplyr::select(c(R_AB_1_n, NA_R_1_n, NOT_NA_1_n, R_AB_2_n, NA_R_2_n, NOT_NA_2_n, R_AB_3_n, NA_R_3_n, NOT_NA_3_n))
# 
# # Imputing data to get rid of missing data
# imputation_model <- mice(superdata, m = 1, method = "pmm")
# imputed_data <- complete(imputation_model, action = "long", include = FALSE)
# 
# # Imputed data for admission
# imputed_data_admission <- imputed_data %>%
#   dplyr::select(-c(.imp, .id, ID, AGE_GROUP, R_AB_1_n, NA_R_1_n, NOT_NA_1_n, R_AB_2_n, NA_R_2_n, NOT_NA_2_n, R_AB_3_n, NA_R_3_n, NOT_NA_3_n))
# 
# # Imputed data for stay
# imputed_data_stay <- imputed_data %>%
#   dplyr::select(c(R_AB_1_n, NA_R_1_n, NOT_NA_1_n, R_AB_2_n, NA_R_2_n, NOT_NA_2_n, R_AB_3_n, NA_R_3_n, NOT_NA_3_n, REC_IM))
# 
# # Imputed data for anamnesis (patient-given history) and ECT
# imputed_data_anamnesis <- imputed_data %>%
#   dplyr::select(c(AGE, SEX, INF_ANAM, STENOK_AN,FK_STENOK,IBS_POST,GB,SIM_GIPERT,DLIT_AG,ZSN_A,nr_11,nr_01,nr_02,nr_03,nr_04,nr_07,nr_08,np_01,np_04,np_05,np_07,np_08,np_09,np_10,endocr_01,endocr_02,endocr_03,zab_leg_01,zab_leg_02,zab_leg_03,zab_leg_06, REC_IM))
# 
# # Imputed data Admission to ICU
# imputed_data_ICU_admit <- imputed_data %>%
#   dplyr::select(c(S_AD_ORIT, D_AD_ORIT,O_L_POST,K_SH_POST,MP_TP_POST,SVT_POST,GT_POST,FIB_G_POST,ant_im,lat_im,inf_im,post_im,IM_PG_P, REC_IM))
# 
# #Imputed data Admission to Hospital
# imputed_data_hospital_admit <- imputed_data %>%
#   dplyr::select(c(ritm_ecg_p_01,ritm_ecg_p_02,ritm_ecg_p_04,ritm_ecg_p_06,ritm_ecg_p_07,ritm_ecg_p_08,n_r_ecg_p_01,n_r_ecg_p_02,n_r_ecg_p_03,n_r_ecg_p_04,n_r_ecg_p_05,n_r_ecg_p_06,n_r_ecg_p_08,n_r_ecg_p_09,n_r_ecg_p_10,n_p_ecg_p_01,n_p_ecg_p_03,n_p_ecg_p_04,n_p_ecg_p_05,n_p_ecg_p_06,n_p_ecg_p_07,n_p_ecg_p_08,n_p_ecg_p_09,n_p_ecg_p_10,n_p_ecg_p_11,n_p_ecg_p_12,fibr_ter_01,fibr_ter_02,fibr_ter_03,fibr_ter_05,fibr_ter_06,fibr_ter_07,fibr_ter_08,GIPO_K,K_BLOOD,GIPER_NA,NA_BLOOD,ALT_BLOOD,AST_BLOOD,L_BLOOD,ROE,TIME_B_S, REC_IM))
# 
# #Imputed data from time in ICU
# imputed_data_ICU_stay <- imputed_data %>%
#   dplyr::select(c(NITR_S,LID_S_n,B_BLOK_S_n,ANT_CA_S_n,GEPAR_S_n,ASP_S_n,TIKL_S_n,TRENT_S_n,R_AB_1_n,R_AB_2_n,R_AB_3_n,NA_R_1_n,NA_R_2_n,NA_R_3_n,NOT_NA_1_n,NOT_NA_2_n,NOT_NA_3_n, REC_IM))

```

```{r missing_analysis, echo=FALSE, warning=FALSE}

# Figures out which factors are most missing using naniar package
miss_var_summary(data)
# miss_var_summary(imputed_data)

```

```{r multicollinearity, echo=FALSE, warning=FALSE}

# write.csv(imputed_data_admission, "./imputed_admission.csv", row.names=FALSE)
# write.csv(imputed_data_stay, "./imputed_stay.csv", row.names=FALSE)
# write.csv(imputed_data_anamnesis, "./imputed_amanesis.csv", row.names=FALSE)
# write.csv(imputed_data_hospital_admit, "./imputed_hospital_admit.csv", row.names=FALSE)
# write.csv(imputed_data_ICU_admit, "./imputed_ICU_admit.csv", row.names=FALSE)
# write.csv(imputed_data_ICU_stay, "./imputed_ICU_stay.csv", row.names=FALSE)

#using data from csv so don't need to do imputation again
imputed_data_admission <- read.csv('imputed_admission.csv')
imputed_data_stay <- read.csv('imputed_stay.csv')
imputed_data_anamnesis <- read.csv('imputed_anamnesis.csv')
imputed_data_hospital_admit <- read.csv('imputed_hospital_admit.csv')
imputed_data_ICU_admit <- read.csv('imputed_ICU_admit.csv')
imputed_data_ICU_stay <- read.csv('imputed_ICU_stay.csv')

# Without removing ritm_ecg_p_01, MC in ritm_ecg_p_01, 02, 04, 07, 08. No MC after removal.
# imputed_data_admission = imputed_data_admission %>%
#   dplyr::select(-c(ritm_ecg_p_01))

# Admission
fit_admission_log <-
  glm(REC_IM ~ ., data = imputed_data_admission, family = 'binomial')
t(t(vif(fit_admission_log)))
summary(fit_admission_log)

# ----------------------------------------------------------------------------

# Stay
fit_stay_log <-
  glm(REC_IM ~ ., data = imputed_data_stay, family = 'binomial')
t(t(vif(fit_stay_log)))
summary(fit_stay_log)


# ----------------------------------------------------------------------------

# Anamnesis
# Removing SIM_GIPERT gets rid of MC
# imputed_data_anamnesis = imputed_data_anamnesis %>% dplyr::select(-c(SIM_GIPERT))
fit_anamnesis <- glm(REC_IM ~ ., data=imputed_data_anamnesis, family='binomial')
t(t(vif(fit_anamnesis)))


# ----------------------------------------------------------------------------

# Hospital Admit
# Removing ritm_ecg_p_01 gets rid of MC
# imputed_data_hospital_admit = imputed_data_hospital_admit %>% dplyr::select(-c(ritm_ecg_p_01))
fit_hosp_admit <- glm(REC_IM ~ ., data=imputed_data_hospital_admit, family='binomial')
t(t(vif(fit_hosp_admit)))



# ----------------------------------------------------------------------------

# ICU admit
fit_ICU_admit <- glm(REC_IM ~ ., data=imputed_data_ICU_admit, family='binomial')
t(t(vif(fit_ICU_admit)))


# ----------------------------------------------------------------------------

# ICU stay
fit_ICU_stay <- glm(REC_IM ~ ., data=imputed_data_ICU_stay, family='binomial')
t(t(vif(fit_ICU_stay)))


```

```{r descriptive_graphs_olivia, echo=FALSE, warning=FALSE}



```

```{r descriptive_graphs_preeti, echo=FALSE, warning=FALSE}

#scatter plot of age vs mi relapse
plot(imputed_data_admission$AGE,imputed_data_admission$REC_IM, main="Scatter Plot: Age", xlab="Age", ylab="MI Relapse")

#bar graph of age vs MI relapse
# Create age buckets
age_buckets <- cut(imputed_data_admission$AGE, breaks = c(0, 30, 40, 50, 60, 70, Inf), labels = c("0-30", "31-40", "41-50", "51-60", "61-70", "71+"))

# Calculate the number of people with and without the disease in each age bucket
disease_counts <- table(age_buckets, imputed_data_admission$REC_IM)

# Plot the bar graph
barplot(t(disease_counts), beside = TRUE, main = "Bar Graph: Age vs MI Relapse",
        xlab = "Age Group", ylab = "Number of People",
        legend = c("No Relapse", "Relapse"), col = c("blue", "red"))

#scatterplot of quantity of infarctions during anamnesis vs mi relapse
plot(imputed_data_admission$INF_ANAM,imputed_data_admission$REC_IM, main="Scatter Plot: Quantity of Myocardial Infarctions in Anamnesis", xlab="Number of Myocardial Infarcations in Anamnesis", ylab="MI Relapse")

```

```{r visualizations, echo=FALSE, warning=FALSE}

# Distribution of ages
# barplot(table(data$AGE), col = rainbow(300), main="Distribution of Ages in the Study",
#         xlab="Number of People",
#         ylab="Age")

# Bar Plot for Age Group by Gender
superdata %>%
  drop_na(AGE_GROUP) %>% # Remove NAs
  ggplot(aes(x = AGE_GROUP,
             fill = SEX)) +
  geom_bar() +
  labs(x = 'Age Group',
       y = 'Count',
       fill = 'Gender',
       title = 'Age Group by Gender')

```

```{r forward selection, echo = FALSE, warning = FALSE}
# FORWARD SELECTION (admission)
# - Define starting model
start.mod <- glm(REC_IM ~ 1 , data = imputed_data_admission, family = 'binomial')

# - Define stopping model 
stop.mod <- formula(glm(REC_IM ~ ., data = imputed_data_admission, 
                           family = 'binomial'))

# - Forward selection
alpha.crit <- 0.2
ffit.admission <- stats::step(start.mod,
             scope=stop.mod,
             direction="forward",
             test="F",
             trace = 0,
             k=qchisq(1-alpha.crit,1))

summary(ffit.admission)
# STENOK_AN + K_SH_POST + np_01 + n_r_ecg_p_06 + AGE +
# D_AD_ORIT + zab_leg_01 + lat_im + n_r_ecg_p_09 + NITR_S +
# GIPER_NA + n_p_ecg_p_03 + np_10 + GEPAR_S_n + TRENT_S_n +
# ANT_CA_S_n + endocr_01 + n_p_ecg_p_10 + zab_leg_02 + FIB_G_POST +
# n_p_ecg_p_11 + IBS_POST + L_BLOOD + TIME_B_S + TIKL_S_n +
# inf_im + nr_03 + ZSN_A 9 + nr_04 + ritm_ecg_p_02 +
# n_p_ecg_p_04

# 31 variables, AIC = 959.23

# ------------------------------------------------------------------------------------

# FORWARD SELECTION (stay)
# - Define starting model
start.mod2 <- glm(REC_IM ~ 1 , data = imputed_data_stay, family = 'binomial')

# Define stopping model
stop.mod2 <- formula(glm(REC_IM ~ ., data = imputed_data_stay, 
                           family = 'binomial'))

# - Forward Selection
alpha.crit <- 0.2
ffit.stay <- stats::step(start.mod2,
             scope=stop.mod2,
             direction="forward",
             test="F",
             k=qchisq(1-alpha.crit,1))
summary(ffit.stay)
# R_AB_3_n + NA_R_2_n + NA_R_1_n
# 3 variables, AIC = 1028.2
```


```{r forward selection split data, echo = FALSE, warning = FALSE}
# FORWARD SELECTION (anamnesis)
start.anamnesis <- glm(REC_IM ~ 1 , data = imputed_data_anamnesis, family = 'binomial')

stop.anamnesis <- formula(glm(REC_IM ~ ., data = imputed_data_anamnesis, 
                           family = 'binomial'))

alpha.crit <- 0.2
ffit.anamnesis <- stats::step(start.anamnesis,
             scope=stop.anamnesis,
             direction="forward",
             trace=0,
             test="F",
             k=qchisq(1-alpha.crit,1))

summary(ffit.anamnesis)
# STENOK_AN + np_01 + AGE + zab_leg_01 + zab_leg_02 + 
# IBS_POST + nr_03 +  nr_11 + endocr_01 + np_08
# 10 variables, AIC = 1008.1

# ------------------------------------------------------------------------------------

# FORWARD SELECTION (ICU admit)
start.ICUadmit <- glm(REC_IM ~ 1 , data = imputed_data_ICU_admit, family = 'binomial')

stop.ICUadmit <- formula(glm(REC_IM ~ ., data = imputed_data_ICU_admit, 
                           family = 'binomial'))

alpha.crit <- 0.2
ffit.ICUadmit <- stats::step(start.ICUadmit,
             scope=stop.ICUadmit,
             direction="forward",
             trace=0,
             test="F",
             k=qchisq(1-alpha.crit,1))

summary(ffit.ICUadmit)
#  GT_POST + K_SH_POST + inf_im + D_AD_ORIT + IM_PG_P
# 5 variables: AIC = 1047.7

# ------------------------------------------------------------------------------------

# FORWARD SELECTION (ICU stay)
start.ICUstay <- glm(REC_IM ~ 1 , data = imputed_data_ICU_stay, family = 'binomial')

stop.ICUstay <- formula(glm(REC_IM ~ ., data = imputed_data_ICU_stay, 
                           family = 'binomial'))

alpha.crit <- 0.2
ffit.ICUstay <- stats::step(start.ICUstay,
             scope=stop.ICUstay,
             direction="forward",
             trace=0,
             test="F",
             k=qchisq(1-alpha.crit,1))

summary(ffit.ICUstay)
# R_AB_3_n + GEPAR_S_n + NA_R_2_n + TRENT_S_n + NA_R_1_n + ANT_CA_S_n
# 6 variables: AIC = 1025.5


# ------------------------------------------------------------------------------------

# FORWARD SELECTION (Hospital admit)
start.HospitalAdmit <- glm(REC_IM ~ 1 , data = imputed_data_hospital_admit, family = 'binomial')

stop.HospitalAdmit<- formula(glm(REC_IM ~ ., data = imputed_data_hospital_admit, 
                           family = 'binomial'))

alpha.crit <- 0.2
ffit.HospitalAdmit <- stats::step(start.HospitalAdmit,
             scope=stop.HospitalAdmit,
             direction="forward",
             trace=0,
             test="F",
             k=qchisq(1-alpha.crit,1))

summary(ffit.HospitalAdmit)
# ritm_ecg_p_07 + n_r_ecg_p_09 + n_r_ecg_p_06 + L_BLOOD + TIME_B_S +
# n_p_ecg_p_11 + n_r_ecg_p_03 + n_r_ecg_p_04 + n_p_ecg_p_08 + n_p_ecg_p_09 + 
# n_p_ecg_p_03
# 11 variables, AIC = 1037.3
```

